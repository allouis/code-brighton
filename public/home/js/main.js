var map;
var markers = [];
var lastinfowindow;
var locIndex;

//Credit: MDN
if ( !Array.prototype.forEach ) {
  Array.prototype.forEach = function(fn, scope) {
    for(var i = 0, len = this.length; i < len; ++i) {
      fn.call(scope, this[i], i, this);
    }
  }
}

/*
This is the data as a JS array. It could be generated by CF of course. This
drives the map and the div on the side.
*/
var data = [
	{address:'68 Middle St Brighton, The City of Brighton and Hove BN1 1AL',title:'68 Middle St.', notes: 'Window on Middle St.', url: 'b93829whateverson'}
];

function initialize() {
	var latlng = new google.maps.LatLng(50.8429, -0.1313);
	var myOptions = {
		zoom: 9,
		center: latlng,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	map = new google.maps.Map(document.getElementById("map_canvas"),myOptions);
	
	geocoder = new google.maps.Geocoder();
	
	data.forEach(function(mapData,idx) {
		geocoder.geocode( { 'address': mapData.address}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					var marker = new google.maps.Marker({
						map: map, 
						position: results[0].geometry.location,
						title: mapData.title
					});
					var contentHtml = "<div style='width:300px;height:200px'><h3>"+mapData.title+"</h3>"+mapData.address+"</div>";
					var infowindow = new google.maps.InfoWindow({
		    			content: contentHtml
					});
					google.maps.event.addListener(marker, 'click', function() {
					  infowindow.open(map,marker);
					});
					marker.locid = idx+1;
					marker.infowindow = infowindow;
					markers[markers.length] = marker;

					var sideHtml = '<p class="loc" data-locid="'+marker.locid+'"><b>'+mapData.title+'</b><br/>';
						 sideHtml += mapData.address + '</p>';
						 $("#locs").append(sideHtml); 

					//Are we all done? Not 100% sure of this
					if(markers.length == data.length) doFilter();

				} else {
					//alert("Geocode was not successful for the following reason: " + status);
				}
			});

	});

	$(document).on("click",".loc",function() {
		var thisloc = $(this).data("locid");
		for(var i=0; i<markers.length; i++) {
			if(markers[i].locid == thisloc) {
				//get the latlong
				if(lastinfowindow instanceof google.maps.InfoWindow) lastinfowindow.close();
				map.panTo(markers[i].getPosition());
				markers[i].infowindow.open(map, markers[i]);
				lastinfowindow = markers[i].infowindow;
			}
		}
	});

	/*
	Run on every change to the checkboxes. If you add more checkboxes to the page,
	we should use a class to make this more specific.
	*/

	function doFilter() {
		if(!locIndex) {
			locIndex = {};
			//I reverse index markers to figure out the position of loc to marker index
			for(var x=0, len=markers.length; x<len; x++) {
				locIndex[markers[x].locid] = x;
			}
		}

		//what's checked?
		var checked = $("input[type=checkbox]:checked");
		var selTypes = [];
		for(var i=0, len=checked.length; i<len; i++) {
			selTypes.push($(checked[i]).val());
		}
		for(var i=0, len=data.length; i<len; i++) {
			var sideDom = "p.loc[data-locid="+(i+1)+"]";

			//Only hide if length != 0
			if(checked.length !=0 && selTypes.indexOf(data[i].type) < 0) {
				$(sideDom).hide();
				markers[locIndex[i+1]].setVisible(false);
			} else {
				$(sideDom).show();
				markers[locIndex[i+1]].setVisible(true);
			}
		}
	}

	$(document).on("click", "input[type=checkbox]", doFilter);

}